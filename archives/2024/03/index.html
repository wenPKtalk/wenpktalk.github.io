
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Summary">
    <title>Archives: 2024/3 - Summary</title>
    <meta name="author" content="Topsion">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="The whole problem with the world is that fools and fanatics are always so certain of themselves, and wiser people so full of doubts.(这个世界的问题在于聪明人充满疑惑而傻子却坚信不疑)">
<meta property="og:type" content="blog">
<meta property="og:title" content="Summary">
<meta property="og:url" content="http://example.com/archives/2024/03/index.html">
<meta property="og:site_name" content="Summary">
<meta property="og:description" content="The whole problem with the world is that fools and fanatics are always so certain of themselves, and wiser people so full of doubts.(这个世界的问题在于聪明人充满疑惑而傻子却坚信不疑)">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Topsion">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="http://example.com/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-yaeygdlgk8x4rqd5mp0jrkosoe3fmfokggmiu05rmpel4wjoxmvp5s6gestz.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Summary
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Topsion</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Fullstack Developer</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/wenPKtalk"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://stackoverflow.com/users/15967860/topsion"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Stack Overflow"
                        >
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/feed/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2024/03/04/Postgres%E6%8A%80%E5%B7%A7/"
                            aria-label=": Postgres技巧"
                        >
                            Postgres技巧
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2024-03-04T15:09:27+00:00">
	
		    Mar 04, 2024
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><h3 id="查找空闲且可能被锁定的进程。"><a href="#查找空闲且可能被锁定的进程。" class="headerlink" title="查找空闲且可能被锁定的进程。"></a>查找空闲且可能被锁定的进程。</h3><blockquote>
<p>这个查询查看pg_stat_activity视图，查找那些活跃但是等待事件或等待事件类型不为空的进程。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">		pid,</span><br><span class="line">		datname,</span><br><span class="line">		usename,</span><br><span class="line">		application_name,</span><br><span class="line">		client_addr,</span><br><span class="line">		client_port,</span><br><span class="line">		to_char (now (), <span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) <span class="keyword">as</span> now,</span><br><span class="line">		to_char (now () <span class="operator">-</span> xact_start, <span class="string">&#x27;DD HH24:MI:SS MS&#x27;</span>) <span class="keyword">as</span> xact_time,</span><br><span class="line">		to_char (now () <span class="operator">-</span> query_start, <span class="string">&#x27;DD HH24:MI:SS MS&#x27;</span>) <span class="keyword">as</span> query_time,</span><br><span class="line">		state,</span><br><span class="line">		to_char (now () <span class="operator">-</span> state_change, <span class="string">&#x27;DD HH24:MI:SS MS&#x27;</span>) <span class="keyword">as</span> state_time,</span><br><span class="line">		wait_event,</span><br><span class="line">		wait_event_type,</span><br><span class="line">		<span class="keyword">left</span> (query, <span class="number">40</span>)</span><br><span class="line">	  <span class="keyword">FROM</span></span><br><span class="line">		pg_stat_activity</span><br><span class="line">	  <span class="keyword">WHERE</span></span><br><span class="line">		state <span class="operator">!=</span> <span class="string">&#x27;idle&#x27;</span></span><br><span class="line">		<span class="keyword">and</span> pid <span class="operator">!=</span> pg_backend_pid ()</span><br><span class="line">	  <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">		query_time <span class="keyword">desc</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="找到具有等待事件的进程，向持有初始锁的PID汇总"><a href="#找到具有等待事件的进程，向持有初始锁的PID汇总" class="headerlink" title="找到具有等待事件的进程，向持有初始锁的PID汇总"></a>找到具有等待事件的进程，向持有初始锁的PID汇总</h3><blockquote>
<p>This query looks at at the pg_stat_activity and pg_locks view showing the pid, state, wait_event, and lock mode, as well as blocking pids.<br>这个查询查看了 pg_stat_activity 和 pg_locks 视图，显示了 pid、state、wait_event 和 lock mode，以及阻塞的 pid。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> sos <span class="keyword">AS</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> array_cat(<span class="built_in">array_agg</span>(pid),</span><br><span class="line">				   <span class="built_in">array_agg</span>((pg_blocking_pids(pid))[array_length(pg_blocking_pids(pid),<span class="number">1</span>)])) pids</span><br><span class="line">			<span class="keyword">FROM</span> pg_locks</span><br><span class="line">			<span class="keyword">WHERE</span> <span class="keyword">NOT</span> granted</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">SELECT</span> a.pid, a.usename, a.datname, a.state,</span><br><span class="line">			   a.wait_event_type <span class="operator">||</span> <span class="string">&#x27;: &#x27;</span> <span class="operator">||</span> a.wait_event <span class="keyword">AS</span> wait_event,</span><br><span class="line">			   <span class="built_in">current_timestamp</span><span class="operator">-</span>a.state_change time_in_state,</span><br><span class="line">			   <span class="built_in">current_timestamp</span><span class="operator">-</span>a.xact_start time_in_xact,</span><br><span class="line">			   l.relation::regclass relname,</span><br><span class="line">			   l.locktype, l.mode, l.page, l.tuple,</span><br><span class="line">			   pg_blocking_pids(l.pid) blocking_pids,</span><br><span class="line">			   (pg_blocking_pids(l.pid))[array_length(pg_blocking_pids(l.pid),<span class="number">1</span>)] last_session,</span><br><span class="line">			   <span class="built_in">coalesce</span>((pg_blocking_pids(l.pid))[<span class="number">1</span>]<span class="operator">||</span><span class="string">&#x27;.&#x27;</span><span class="operator">||</span><span class="built_in">coalesce</span>(<span class="keyword">case</span> <span class="keyword">when</span> locktype<span class="operator">=</span><span class="string">&#x27;transactionid&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> array_length(pg_blocking_pids(l.pid),<span class="number">1</span>)<span class="operator">+</span><span class="number">1</span> <span class="keyword">end</span>,<span class="number">0</span>),a.pid<span class="operator">||</span><span class="string">&#x27;.0&#x27;</span>) lock_depth,</span><br><span class="line">			   a.query</span><br><span class="line">		<span class="keyword">FROM</span> pg_stat_activity a</span><br><span class="line">			 <span class="keyword">JOIN</span> sos s <span class="keyword">on</span> (a.pid <span class="operator">=</span> <span class="keyword">any</span>(s.pids))</span><br><span class="line">			 <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> pg_locks l <span class="keyword">on</span> (a.pid <span class="operator">=</span> l.pid <span class="keyword">and</span> <span class="keyword">not</span> l.granted)</span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> lock_depth;</span><br></pre></td></tr></table></figure>

<h3 id="Set-a-lock-timeout"><a href="#Set-a-lock-timeout" class="headerlink" title="Set a lock timeout"></a>Set a lock timeout</h3><blockquote>
<p>It can be a good idea to set a lock_timeout within a session so that it will cancel the transaction and relinquish any locks it was holding after a certain period of time.<br>在会话中设置一个锁定超时可能是个好主意，这样在一段时间后它会取消事务并释放任何它持有的锁。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> lock_timeout <span class="operator">=</span> <span class="string">&#x27;10s&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h2><h3 id="设置log-min-duration-statement来记录慢查询。"><a href="#设置log-min-duration-statement来记录慢查询。" class="headerlink" title="设置log_min_duration_statement来记录慢查询。"></a>设置log_min_duration_statement来记录慢查询。</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> database postgres <span class="keyword">SET</span> log_min_duration_statement <span class="operator">=</span> <span class="string">&#x27;250ms&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="控制记录哪些类型的语句"><a href="#控制记录哪些类型的语句" class="headerlink" title="控制记录哪些类型的语句"></a>控制记录哪些类型的语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE postgres <span class="keyword">SET</span> log_statement <span class="operator">=</span> <span class="string">&#x27;all&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="等待锁时记录"><a href="#等待锁时记录" class="headerlink" title="等待锁时记录"></a>等待锁时记录</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE postgres <span class="keyword">SET</span> log_lock_waits <span class="operator">=</span> <span class="string">&#x27;on&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="PERFORMANCE"><a href="#PERFORMANCE" class="headerlink" title="PERFORMANCE"></a>PERFORMANCE</h2><h3 id="使用语句超时来控制运行超时的查询。"><a href="#使用语句超时来控制运行超时的查询。" class="headerlink" title="使用语句超时来控制运行超时的查询。"></a>使用语句超时来控制运行超时的查询。</h3><blockquote>
<p>Setting a statement timeout prevents queries from running longer than the specified time. You can set a statement timeout on the database, user, or session level. We recommend you set a global timeout on Postgres and then override that one specific users or sessions that need a longer allowed time to run.<br>设置语句超时时间可以防止查询运行时间超过指定的时间。您可以在数据库、用户或会话级别上设置语句超时时间。我们建议您在Postgres上设置一个全局超时时间，然后针对需要更长运行时间的特定用户或会话进行覆盖设置。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE mydatabase <span class="keyword">SET</span> statement_timeout <span class="operator">=</span> <span class="string">&#x27;60s&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="使用pg-stat-statements-需要安装-来查找使用最多资源的查询和进程。"><a href="#使用pg-stat-statements-需要安装-来查找使用最多资源的查询和进程。" class="headerlink" title="使用pg_stat_statements[需要安装]来查找使用最多资源的查询和进程。"></a>使用pg_stat_statements[需要安装]来查找使用最多资源的查询和进程。</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 安装pg_stat_statements</span></span><br><span class="line"><span class="comment">-- Create the extension</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION pg_stat_statements;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Change in config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> shared_preload_libraries<span class="operator">=</span><span class="string">&#x27;pg_stat_statements&#x27;</span>;</span><br><span class="line">Restart</span><br><span class="line"></span><br><span class="line"><span class="comment">-- systemctl restart postgresql</span></span><br><span class="line"><span class="comment">-- Verify changes applied or not.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_file_Settings <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;shared_preload_libraries&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	total_exec_time,</span><br><span class="line">	mean_exec_time <span class="keyword">as</span> avg_ms,</span><br><span class="line">	calls,</span><br><span class="line">	query</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_statements</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> mean_exec_time <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h3 id="监视Postgres中的连接"><a href="#监视Postgres中的连接" class="headerlink" title="监视Postgres中的连接"></a>监视Postgres中的连接</h3><blockquote>
<p>This query will provide the number of connection based on type.<br>此查询将根据类型提供连接数量。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>),</span><br><span class="line">	   state</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_activity</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> state;</span><br></pre></td></tr></table></figure>

<h3 id="查询特定表的大小"><a href="#查询特定表的大小" class="headerlink" title="查询特定表的大小"></a>查询特定表的大小</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_relation_size(<span class="string">&#x27;table_name&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- For prettier formatting you can wrap with:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> pg_size_pretty(pg_relation_size(<span class="string">&#x27;table_name&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="查询所有表的大小"><a href="#查询所有表的大小" class="headerlink" title="查询所有表的大小"></a>查询所有表的大小</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> relname <span class="keyword">AS</span> relation,</span><br><span class="line">       pg_size_pretty (</span><br><span class="line">         pg_total_relation_size (C .oid)</span><br><span class="line">       ) <span class="keyword">AS</span> total_size</span><br><span class="line"><span class="keyword">FROM</span> pg_class C</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> pg_namespace N <span class="keyword">ON</span> (N.oid <span class="operator">=</span> C .relnamespace)</span><br><span class="line"><span class="keyword">WHERE</span> nspname <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">        <span class="string">&#x27;pg_catalog&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;information_schema&#x27;</span></span><br><span class="line">      )</span><br><span class="line">  <span class="keyword">AND</span> C .relkind <span class="operator">&lt;&gt;</span> <span class="string">&#x27;i&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> nspname <span class="operator">!</span><span class="operator">~</span> <span class="string">&#x27;^pg_toast&#x27;</span></span><br><span class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> pg_total_relation_size (C .oid) <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>

<h3 id="检查未使用的索引。"><a href="#检查未使用的索引。" class="headerlink" title="检查未使用的索引。"></a>检查未使用的索引。</h3><blockquote>
<p>Will return the unused indexes in descending order of size. Keep in mind you want to also check replicas before dropping indexes.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> schemaname <span class="operator">||</span> <span class="string">&#x27;.&#x27;</span> <span class="operator">||</span> relname <span class="keyword">AS</span> <span class="keyword">table</span>,</span><br><span class="line">       indexrelname <span class="keyword">AS</span> index,</span><br><span class="line">       pg_size_pretty(pg_relation_size(i.indexrelid)) <span class="keyword">AS</span> &quot;index size&quot;,</span><br><span class="line">       idx_scan <span class="keyword">as</span> &quot;index scans&quot;</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_user_indexes ui</span><br><span class="line"><span class="keyword">JOIN</span> pg_index i <span class="keyword">ON</span> ui.indexrelid <span class="operator">=</span> i.indexrelid</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> indisunique</span><br><span class="line">  <span class="keyword">AND</span> idx_scan <span class="operator">&lt;</span> <span class="number">50</span></span><br><span class="line">  <span class="keyword">AND</span> pg_relation_size(relid) <span class="operator">&gt;</span> <span class="number">5</span> <span class="operator">*</span> <span class="number">8192</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">  pg_relation_size(i.indexrelid) <span class="operator">/</span> <span class="built_in">nullif</span>(idx_scan, <span class="number">0</span>) <span class="keyword">DESC</span> <span class="keyword">NULLS FIRST</span>,</span><br><span class="line">  pg_relation_size(i.indexrelid) <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="获取表格的近似计数"><a href="#获取表格的近似计数" class="headerlink" title="获取表格的近似计数"></a>获取表格的近似计数</h3><blockquote>
<p>Will return the approximate count for a table based on PostgreSQL internal statistics. Useful for large tables where performing a <code>SELECT count(*)</code> is costly on performance.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> reltuples::<span class="type">numeric</span> <span class="keyword">as</span> count</span><br><span class="line"><span class="keyword">FROM</span> pg_class</span><br><span class="line"><span class="keyword">WHERE</span> relname<span class="operator">=</span><span class="string">&#x27;table_name&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Non-blocking-创建索引"><a href="#Non-blocking-创建索引" class="headerlink" title="Non-blocking 创建索引"></a>Non-blocking 创建索引</h3><blockquote>
<p>Adding <code>CONCURRENTLY</code> during index creation, while not permitted in a transaction, will not hold a lock on the table while creating your index.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX CONCURRENTLY foobar <span class="keyword">ON</span> foo (bar);</span><br></pre></td></tr></table></figure>

<h2 id="PSQL"><a href="#PSQL" class="headerlink" title="PSQL"></a>PSQL</h2><h3 id="在PSQL中自动记录查询时间"><a href="#在PSQL中自动记录查询时间" class="headerlink" title="在PSQL中自动记录查询时间"></a>在PSQL中自动记录查询时间</h3><blockquote>
<p>将自动打印出在psql中运行查询所花费的时间。<em>需要注意的是这是往返时间，而不仅仅是查询执行时间。</em></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\timing</span><br></pre></td></tr></table></figure>

<h3 id="在-psql-中自动格式化查询结果"><a href="#在-psql-中自动格式化查询结果" class="headerlink" title="在 psql 中自动格式化查询结果"></a>在 psql 中自动格式化查询结果</h3><blockquote>
<p>将根据您的终端窗口自动重新组织查询输出，以便更易读。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x auto</span><br></pre></td></tr></table></figure>

<h3 id="编辑您选择的编辑器中的psql查询"><a href="#编辑您选择的编辑器中的psql查询" class="headerlink" title="编辑您选择的编辑器中的psql查询"></a>编辑您选择的编辑器中的psql查询</h3><blockquote>
<p>将自动在您的默认 <code>$EDITOR</code> 中打开您上次运行的查询。当您保存并关闭时，将执行该查询。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\e</span><br></pre></td></tr></table></figure>

<h3 id="为nulls设置一个值"><a href="#为nulls设置一个值" class="headerlink" title="为nulls设置一个值"></a>为nulls设置一个值</h3><blockquote>
<p>将null渲染为您指定的任何字符。对于更容易解析null和空文本非常方便。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\pset <span class="keyword">null</span> 👻</span><br></pre></td></tr></table></figure>

<h3 id="将您的每个数据库的查询历史保存在本地"><a href="#将您的每个数据库的查询历史保存在本地" class="headerlink" title="将您的每个数据库的查询历史保存在本地"></a>将您的每个数据库的查询历史保存在本地</h3><blockquote>
<p>将为每个<strong>DBNAME</strong>自动保存一个历史文件。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="keyword">set</span> HISTFILE <span class="operator">~</span><span class="operator">/</span>.psql_history<span class="operator">-</span> :DBNAME</span><br></pre></td></tr></table></figure>

<h3 id="显示由内部psql命令发出的查询"><a href="#显示由内部psql命令发出的查询" class="headerlink" title="显示由内部psql命令发出的查询"></a>显示由内部psql命令发出的查询</h3><blockquote>
<p>在命令行中为 psql 添加“-E”（或–echo-hidden）选项。此选项将显示内部 psql 命令生成的查询（例如“\dt mytable”）。这是了解系统目录的更酷的方法，或者可以重用由 psql 发出的查询在您自己的工具中。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql <span class="operator">-</span>E</span><br></pre></td></tr></table></figure>

<h3 id="获取数据，只需数据。"><a href="#获取数据，只需数据。" class="headerlink" title="获取数据，只需数据。"></a>获取数据，只需数据。</h3><blockquote>
<p>在命令行中向psql添加”-qtA”选项。这些选项将使psql以安静模式(“-q”)运行，仅返回元组(“-t”)以不对齐的方式(“-A”)。结合”-c”选项发送单个查询，如果您只想从Postgres获取数据，这对于您的脚本可能很有用。每行返回一行。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql <span class="operator">-</span>qtA</span><br></pre></td></tr></table></figure>

<h3 id="以HTML表格的形式获取结果"><a href="#以HTML表格的形式获取结果" class="headerlink" title="以HTML表格的形式获取结果"></a>以HTML表格的形式获取结果</h3><blockquote>
<p>在命令行中为psql添加”-qtH”选项。这些选项将使psql以安静模式运行（”-q”），仅返回元组（”-t”）以HTML表格形式（”-H”）。结合”-c”选项发送单个查询，可以快速将查询结果嵌入到HTML页面中。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql <span class="operator">-</span>qtH</span><br></pre></td></tr></table></figure>

<h3 id="搜索以前的查询使用-Ctrl-R"><a href="#搜索以前的查询使用-Ctrl-R" class="headerlink" title="搜索以前的查询使用 Ctrl + R"></a>搜索以前的查询使用 Ctrl + R</h3><blockquote>
<p>按下Ctrl + R将启动搜索会话，然后您可以开始键入查询或命令的一部分，以找到并再次运行它。如果您使用注释标记特定查询，这可以帮助稍后进行搜索。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(reverse<span class="operator">-</span>i<span class="operator">-</span><span class="keyword">search</span>)</span><br></pre></td></tr></table></figure>

<h3 id="清除plsql屏幕"><a href="#清除plsql屏幕" class="headerlink" title="清除plsql屏幕"></a>清除plsql屏幕</h3><blockquote>
<p>将清除当前 psql 会话中的屏幕</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="operator">!</span> clear</span><br></pre></td></tr></table></figure>

<h3 id="持续使用watch命令运行查询"><a href="#持续使用watch命令运行查询" class="headerlink" title="持续使用watch命令运行查询"></a>持续使用watch命令运行查询</h3><blockquote>
<p>每2秒将自动运行上次的查询并显示输出。您也可以在watch后指定要运行的查询。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\watch</span><br></pre></td></tr></table></figure>

<h3 id="在交互模式下，当出现错误时回滚到上一个语句。"><a href="#在交互模式下，当出现错误时回滚到上一个语句。" class="headerlink" title="在交互模式下，当出现错误时回滚到上一个语句。"></a>在交互模式下，当出现错误时回滚到上一个语句。</h3><blockquote>
<p>当您在交互模式遇到错误时，系统会自动回滚到前一条命令之前的状态，使您可以像预期的那样继续工作。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="keyword">set</span> ON_ERROR_ROLLBACK interactive</span><br></pre></td></tr></table></figure>

<h3 id="直接从psql导出CSV"><a href="#直接从psql导出CSV" class="headerlink" title="直接从psql导出CSV"></a>直接从psql导出CSV</h3><blockquote>
<p>当使用查询时提供<code>--csv</code>值，该命令将运行特定查询并将CSV返回到标准输出。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql <span class="operator">&lt;</span>connection<span class="operator">-</span>string<span class="operator">&gt;</span> <span class="comment">--csv -c &#x27;select * from test;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="在psql中运行来自文件的查询"><a href="#在psql中运行来自文件的查询" class="headerlink" title="在psql中运行来自文件的查询"></a>在psql中运行来自文件的查询</h3><blockquote>
<p>在 psql 中执行指定的文件。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\i filename</span><br></pre></td></tr></table></figure>

<h3 id="在-psql-中提供清晰的边框"><a href="#在-psql-中提供清晰的边框" class="headerlink" title="在 psql 中提供清晰的边框"></a>在 psql 中提供清晰的边框</h3><blockquote>
<p>在psql中，当你查询结果输出时，会给结果加上边框。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\pset border <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h2 id="Refer"><a href="#Refer" class="headerlink" title="Refer"></a>Refer</h2><p><a target="_blank" rel="noopener" href="https://www.crunchydata.com/postgres-tips">https://www.crunchydata.com/postgres-tips</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2024/03/04/Postgres%E6%8A%80%E5%B7%A7/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">page 1 of 1</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Topsion. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Topsion</h4>
        
            <div id="about-card-bio"><p>Fullstack Developer</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Coder</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Xi&#39;an China
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-q2wtdh1f7oaxzdmuuvsc1uyl8fnwcg5dz7kgztdayssvj6qd6o7u5zwralwk.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
